name: Pipeline

permissions:
  contents: write
  pull-requests: write

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

concurrency:
  group: pipeline-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ─────────────────────────────────────────────
  # JOB 1: FORMAT & TEST (Run only on Push/PR/Dispatch)
  # ─────────────────────────────────────────────
  format-and-test:
    # not run every 6 hours on cron, but only on push/pr/dispatch
    if: github.event_name != 'schedule'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Set up Python 
        uses: actions/setup-python@v6 
        with:
          python-version-file: "pyproject.toml"

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install dependencies 
        run: uv sync

      - name: Configure git identity
        run: |
            git config --global user.name "github-actions[bot]"
            git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Lint and fix Markdown
        uses: DavidAnson/markdownlint-cli2-action@v22 
        with:
          fix: true
          globs: '**/*.md'
        continue-on-error: true

      - name: Run ruff (fix and format)
        run: |
          uv run ruff check . --fix
          uv run ruff format .

      - name: Commit and push ALL formatting fixes
        if: github.event_name == 'push'
        run: |
          # safe branch name for both PRs and direct pushes
          BRANCH_NAME="${{ github.head_ref || github.ref_name }}"
          
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "Auto-fix formatting (Markdown & Ruff)"
            git pull --rebase origin "$BRANCH_NAME"
            git push origin "HEAD:refs/heads/$BRANCH_NAME"
          else
            echo "No formatting changes to commit."
          fi

      - name: Run tests
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: uv run pytest tests/ -v

  # ─────────────────────────────────────────────
  # JOB 2: UPDATE HOSTS (Run only on Schedule or Dispatch)
  # ─────────────────────────────────────────────
  update-hosts:
    # run only timer from cron or manual trigger, not on push/pr
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Python 
        uses: actions/setup-python@v6 
        with:
          python-version-file: "pyproject.toml"

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Run conversion script
        run: uv run convert_to_hosts.py

      - name: Commit and push hosts.txt
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          if [[ -n $(git status --porcelain hosts.txt) ]]; then
            git add hosts.txt
            git commit -m "Update hosts.txt via schedule"
            git pull --rebase origin main
            git push origin main
          else
            echo "No changes to commit."
          fi
